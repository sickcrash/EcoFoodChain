apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloud-gaming-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cloud-gaming-test
  template:
    metadata:
      labels:
        app: cloud-gaming-test
    spec:
      containers:
      # --- CONTAINER UNITY ---
      - name: unity-renderer
        image: ecofoodchain/cloud-gaming-test:latest
        imagePullPolicy: IfNotPresent
        # FIX 1: Definiamo la variabile mancante
        env:
        - name: XDG_RUNTIME_DIR
          value: "/tmp"
        # FIX 2: Argomenti pi√π robusti per evitare crash audio/video
        args: 
          - "-batchmode" 
          - "-nographics" 
          - "-noUmp" 
          - "-nolog" # Disabilita il log interno per evitare conflitti di I/O
          - "-signalingURL" 
          - "ws://localhost:80"

      # --- CONTAINER SIGNALING ---
      - name: signaling-server
        image: unitytechnologies/render-streaming-webserver:3.1.0
        imagePullPolicy: IfNotPresent
        command: ["npm", "run", "start", "--", "-w", "80"]
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: cloud-gaming-test
spec:
  type: ClusterIP
  selector:
    app: cloud-gaming-test
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80